<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è±†ç“£ç”µå½±Top10æ•°æ®å±•ç¤º</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Microsoft YaHei', sans-serif;
      background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      overflow: hidden;
    }

    .header {
      background: #ff6b81;
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .header p {
      opacity: 0.8;
      font-size: 1.1em;
    }

    .controls {
      background: #ff8fab;
      padding: 15px;
      text-align: center;
    }

    .btn {
      background: #ff6b81;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 0 10px;
      font-size: 14px;
      transition: background 0.3s;
    }

    .btn:hover {
      background: #ff5252;
    }

    .btn-refresh {
      background: #ff4081;
    }

    .btn-refresh:hover {
      background: #f50057;
    }

    .status-bar {
      background: #f8f9fa;
      padding: 10px 20px;
      border-bottom: 1px solid #e9ecef;
      font-size: 14px;
      color: #6c757d;
    }

    .charts-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      padding: 20px;
    }

    .chart-box {
      background: #fff0f5;
      border-radius: 10px;
      padding: 10px;
      height: 500px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .chart-container {
      width: 80%;
      height: 60%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .movie-list {
      padding: 20px;
    }

    .movie-item {
      display: flex;
      align-items: center;
      background: #f8f9fa;
      margin: 10px 0;
      padding: 15px;
      border-radius: 8px;
      transition: transform 0.2s;
    }

    .movie-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .movie-poster {
      width: 80px;
      height: 120px;
      object-fit: cover;
      border-radius: 5px;
      margin-right: 20px;
    }

    .movie-info {
      flex: 1;
    }

    .movie-title {
      font-size: 1.2em;
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 5px;
    }

    .movie-score {
      color: #e74c3c;
      font-size: 1.1em;
      font-weight: bold;
    }

    .movie-quote {
      color: #7f8c8d;
      font-style: italic;
      margin-top: 5px;
    }

    .loading {
      text-align: center;
      padding: 50px;
      color: #7f8c8d;
    }

    .error {
      text-align: center;
      padding: 50px;
      color: #e74c3c;
      background: #ffeaa7;
      margin: 20px;
      border-radius: 10px;
    }

    @media (max-width: 768px) {
      .charts-container {
        grid-template-columns: 1fr;
      }

      .movie-item {
        flex-direction: column;
        text-align: center;
      }

      .movie-poster {
        margin-right: 0;
        margin-bottom: 10px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¬ è±†ç“£ç”µå½±Top10æ•°æ®å±•ç¤º</h1>
      <p>åŸºäºNode.jsçˆ¬è™« + EChartså¯è§†åŒ–</p>
    </div>

    <div class="controls">
      <button class="btn btn-refresh" onclick="fetchData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
      <button class="btn" onclick="window.location.href='/admin'">âš™ï¸ ç®¡ç†é¡µé¢</button>
    </div>

    <div class="status-bar" id="statusBar">
      æ­£åœ¨æ£€æŸ¥æ•°æ®çŠ¶æ€...
    </div>

    <div id="loading" class="loading" style="display: none;">
      <h2>æ­£åœ¨åŠ è½½æ•°æ®...</h2>
    </div>

    <div id="error" class="error" style="display: none;">
      <h2>æ•°æ®åŠ è½½å¤±è´¥</h2>
      <p id="errorMessage"></p>
      <button class="btn btn-refresh" onclick="fetchData()">ç‚¹å‡»é‡è¯•</button>
    </div>

    <div id="content" style="display: none;">
      <div class="charts-container">
        <div class="chart-box">
          <h3 style="text-align: center; margin-bottom: 10px; color: #ff6b81; font-size: 18px;">ç”µå½±è¯„åˆ†åˆ†å¸ƒ</h3>
          <div class="chart-container">
            <div id="scoreChart" style="width: 100%; height: 100%;"></div>
          </div>
        </div>
        <div class="chart-box">
          <h3 style="text-align: center; margin-bottom: 10px; color: #ff6b81; font-size: 18px;">é«˜è¯„åˆ†ç”µå½±å æ¯”</h3>
          <div class="chart-container">
            <div id="rankingChart" style="width: 100%; height: 100%;"></div>
          </div>
        </div>
      </div>

      <div class="movie-list">
        <h2 style="text-align: center; margin: 20px 0; color: #2c3e50;">ğŸ¥ ç”µå½±è¯¦æƒ…åˆ—è¡¨</h2>
        <div id="movieList"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <script>
    // åˆå§‹åŒ–å›¾è¡¨
    let scoreChart, rankingChart;

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function () {
      setTimeout(() => {
        // ç¡®ä¿å®¹å™¨æœ‰æ­£ç¡®çš„å°ºå¯¸
        const scoreChartElement = document.getElementById('scoreChart');
        const rankingChartElement = document.getElementById('rankingChart');

        // è®¾ç½®å›ºå®šå°ºå¯¸
        scoreChartElement.style.width = '100%';
        scoreChartElement.style.height = '400px';
        rankingChartElement.style.width = '100%';
        rankingChartElement.style.height = '400px';

        scoreChart = echarts.init(scoreChartElement);
        rankingChart = echarts.init(rankingChartElement);
        checkStatus();
        fetchData();
      }, 100);
    });

    // æ£€æŸ¥æ•°æ®çŠ¶æ€
    async function checkStatus() {
      try {
        const response = await fetch('/api/status');
        const data = await response.json();

        if (data.hasData) {
          document.getElementById('statusBar').innerHTML =
            `å½“å‰æœ‰ ${data.movieCount} æ¡æ•°æ®ï¼Œæœ€åæ›´æ–°: ${new Date(data.lastUpdated).toLocaleString()}`;
        } else {
          document.getElementById('statusBar').innerHTML = 'æš‚æ— æ•°æ®ï¼Œè¯·å…ˆæ›´æ–°æ•°æ®';
        }
      } catch (error) {
        document.getElementById('statusBar').innerHTML = 'çŠ¶æ€æ£€æŸ¥å¤±è´¥';
      }
    }

    // å‰ç«¯è·å–åç«¯æ•°æ®
    const fetchData = async () => {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('content').style.display = 'none';
      document.getElementById('error').style.display = 'none';

      try {
        const response = await fetch('/api/movies');
        const data = await response.json();

        if (data.success) {
          const movies = data.data;
          console.log('ä»åç«¯è·å–åˆ°çš„ç”µå½±æ•°æ®:', movies);
          updateCharts(movies);
          updateMovieList(movies);
          checkStatus();
        } else {
          showError(data.error);
        }
      } catch (error) {
        showError('ç½‘ç»œè¯·æ±‚å¤±è´¥: ' + error.message);
      } finally {
        document.getElementById('loading').style.display = 'none';
      }
    };

    // æ˜¾ç¤ºé”™è¯¯
    function showError(message) {
      document.getElementById('error').style.display = 'block';
      document.getElementById('errorMessage').textContent = message;
    }

    // æ›´æ–°å›¾è¡¨
    function updateCharts(movies) {
      document.getElementById('content').style.display = 'block';

      // å‡†å¤‡è¯„åˆ†å›¾è¡¨æ•°æ®
      const scoreOption = {
        tooltip: {
          trigger: 'axis',
          formatter: '{b}: {c}åˆ†'
        },
        xAxis: {
          type: 'category',
          data: movies.map(movie => movie.name.split('/')[0]),
          axisLabel: { rotate: 45 }
        },
        yAxis: {
          type: 'value',
          name: 'è¯„åˆ†',
          min: 8,
          max: 10
        },
        series: [{
          data: movies.map(movie => parseFloat(movie.score)),
          type: 'bar',
          itemStyle: {
            color: function (params) {
              const score = params.data;
              return score >= 9.5 ? '#e74c3c' :
                score >= 9.0 ? '#3498db' : '#f39c12';
            }
          }
        }]
      };

      // å‡†å¤‡é«˜è¯„åˆ†ç”µå½±å æ¯”å›¾è¡¨æ•°æ®
      const highScoreMovies = movies.filter(movie => parseFloat(movie.score) > 9.5);
      const highScoreCount = highScoreMovies.length;
      const otherCount = movies.length - highScoreCount;

      const rankingOption = {
        tooltip: {
          trigger: 'item',
          formatter: '{a} <br/>{b}: {c}éƒ¨ ({d}%)'
        },
        series: [{
          name: 'ç”µå½±æ•°é‡',
          type: 'pie',
          radius: ['40%', '70%'],
          data: [
            {
              value: highScoreCount,
              name: 'è¯„åˆ†>9.5'
            },
            {
              value: otherCount,
              name: 'è¯„åˆ†â‰¤9.5'
            }
          ],
          itemStyle: {
            color: function (params) {
              return params.dataIndex === 0 ? '#ff6b81' : '#f39c12';
            }
          },
          emphasis: {
            itemStyle: {
              shadowBlur: 10,
              shadowOffsetX: 0,
              shadowColor: 'rgba(0, 0, 0, 0.5)'
            }
          }
        }]
      };

      // æ›´æ–°å›¾è¡¨
      scoreChart.setOption(scoreOption);
      rankingChart.setOption(rankingOption);
    }

    // æ›´æ–°ç”µå½±åˆ—è¡¨
    function updateMovieList(movies) {
      const movieList = document.getElementById('movieList');
      movieList.innerHTML = movies.map(movie => {
        // ä½¿ç”¨æœ¬åœ°å›¾ç‰‡è·¯å¾„
        // ä½¿ç”¨æœ¬åœ°å›¾ç‰‡è·¯å¾„
        // ä½¿ç”¨è±†ç“£ç”µå½±çš„åŸå§‹å°é¢URL
        const localImagePath = movie.coverUrl || 'é»˜è®¤å›¾ç‰‡';
        return `
        <div class="movie-item">
          <img src="${localImagePath}" alt="${movie.name}" class="movie-poster" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iMTIwIiB2aWV3Qm94PSIwIDAgODAgMTIwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSI4MCIgaGVpZ2h0PSIxMjAiIGZpbGw9IiNlZGVkZWQiLz48dGV4dCB4PSI0MCIgeT0iNjAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM5OTk5OTkiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMiI+5Zu+54mHPC90ZXh0Pjwvc3ZnPg=='" />
          <div class="movie-info">
            <div class="movie-title">${movie.name}</div>
            <div class="movie-score" style="color: #ff6b81;">â­ è¯„åˆ†: ${movie.score}</div>
            <div>ğŸ† æ’å: ç¬¬${movie.ranking}å</div>
            ${movie.quote ? `<div class="movie-quote">"${movie.quote}"</div>` : ''}
            ${movie.otherNames ? `<div style="color: #7f8c8d; margin-top: 5px;">åˆ«å: ${movie.otherNames}</div>` : ''}
          </div>
        </div>
        `;
      }).join('');
    }

    // çª—å£å¤§å°å˜åŒ–æ—¶é‡ç»˜å›¾è¡¨
    window.addEventListener('resize', function () {
      if (scoreChart) {
        const scoreChartElement = document.getElementById('scoreChart');
        scoreChartElement.style.height = '400px';
        scoreChart.resize();
      }
      if (rankingChart) {
        const rankingChartElement = document.getElementById('rankingChart');
        rankingChartElement.style.height = '400px';
        rankingChart.resize();
      }
    });
  </script>
</body>

</html>